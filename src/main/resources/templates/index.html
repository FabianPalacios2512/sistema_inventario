<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <title>Central de Inteligencia | Grupo Ã‰xito</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    
    <script>
      tailwind.config = { darkMode: 'class' };
    </script>
    
    <script>
        if (localStorage.getItem('theme') === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark');
        } else {
            document.documentElement.classList.remove('dark');
        }
    </script>

    <style>
        body { font-family: 'Inter', sans-serif; }
        .transition-all-300 { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .aurora-background { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; overflow: hidden; background-color: #f8fafc; }
        .dark .aurora-background { background-color: #020617; }
        .aurora-background::before, .aurora-background::after { content: ''; position: absolute; width: 50vw; height: 50vw; border-radius: 50%; filter: blur(120px); opacity: 0.1; transition: all 0.5s ease-in-out; }
        .aurora-background::before { background: radial-gradient(circle, #38bdf8, transparent); top: -15%; left: -15%; }
        .aurora-background::after { background: radial-gradient(circle, #fbbf24, transparent); bottom: -15%; right: -15%; }
        .dark .aurora-background::before { background: radial-gradient(circle, #3b82f6, transparent); opacity: 0.15; }
        .dark .aurora-background::after { background: radial-gradient(circle, #4f46e5, transparent); opacity: 0.15; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fadeIn { animation: fadeIn 0.5s ease-out forwards; }
        .animate-fadeInUp { animation: fadeInUp 0.5s ease-out forwards; }
        .tab-btn.active, .chart-filter-btn.active { background-color: #0ea5e9 !important; color: white !important; }
        .dark .tab-btn.active, .dark .chart-filter-btn.active { background-color: #38bdf8 !important; }
    </style>
</head>
<body class="antialiased">
    <div class="aurora-background"></div>

    <div class="flex h-screen">
        <aside class="bg-white/50 dark:bg-slate-800/50 backdrop-blur-lg w-64 flex-col z-40 shadow-lg border-r border-slate-200/50 dark:border-slate-700/50 hidden md:flex">
            <div class="flex items-center justify-center h-20 border-b border-slate-200/50 dark:border-slate-700/50">
                <img th:src="@{/img/logo_exito.png}" alt="Logo" class="w-28">
            </div>
            <nav class="flex-1 px-4 py-4 space-y-2">
                <a href="#" class="flex items-center px-3 py-2.5 rounded-lg text-white bg-sky-500 font-semibold shadow"><i class="fas fa-home w-6 text-lg"></i><span class="ml-4">Panel de Control</span></a>
                <a href="#" class="flex items-center px-3 py-2.5 rounded-lg text-slate-600 dark:text-slate-300 hover:bg-black/5 dark:hover:bg-white/5 font-medium"><i class="fas fa-boxes-stacked w-6 text-lg text-slate-400"></i><span class="ml-4">Inventario</span></a>
                <a href="#" class="flex items-center px-3 py-2.5 rounded-lg text-slate-600 dark:text-slate-300 hover:bg-black/5 dark:hover:bg-white/5 font-medium"><i class="fas fa-chart-pie w-6 text-lg text-slate-400"></i><span class="ml-4">Reportes</span></a>
                <a href="#" sec:authorize="hasRole('ADMINISTRADOR')" class="flex items-center px-3 py-2.5 rounded-lg text-slate-600 dark:text-slate-300 hover:bg-black/5 dark:hover:bg-white/5 font-medium"><i class="fas fa-users-cog w-6 text-lg text-slate-400"></i><span class="ml-4">Admin Usuarios</span></a>
            </nav>
            <div class="p-4 border-t border-slate-200/50 dark:border-slate-700/50">
                 <div class="flex items-center">
                    <div class="w-10 h-10 rounded-full flex items-center justify-center bg-amber-400 text-slate-800 font-bold"><span th:text="${#strings.substring(#authentication.principal.username, 0, 1).toUpperCase()}"></span></div>
                    <div class="ml-3 flex-1"><p class="font-bold text-sm text-slate-800 dark:text-white truncate" th:text="${#authentication.principal.username}"></p><p class="text-xs text-slate-500 dark:text-slate-400" th:text="${#strings.capitalize(#strings.replace(#authentication.principal.authorities[0].getAuthority().toLowerCase(), 'role_', ''))}"></p></div>
                    <form th:action="@{/logout}" method="post" class="ml-auto"><button type="submit" title="Cerrar SesiÃ³n" class="w-9 h-9 flex items-center justify-center rounded-lg text-slate-500 dark:text-slate-400 hover:bg-black/5 dark:hover:bg-white/5"><i class="fas fa-sign-out-alt text-lg"></i></button></form>
                </div>
            </div>
        </aside>

        <div class="flex-1 flex flex-col overflow-hidden">
            <header class="bg-white/30 dark:bg-slate-800/30 backdrop-blur-lg z-10 border-b border-slate-200/30 dark:border-slate-700/30">
                <div class="mx-auto px-6 h-20 flex items-center justify-between">
                    <div>
                        <h1 class="text-2xl font-black text-slate-900 dark:text-white">Hola, <span th:text="${#authentication.principal.username.split('@')[0]}"></span> ðŸ‘‹</h1>
                        <p id="live-clock" class="text-sm text-slate-500 dark:text-slate-400"></p>
                    </div>
                    <div class="flex items-center space-x-4">
                        <button id="command-palette-button" class="flex items-center space-x-2 px-3 py-2 rounded-lg text-slate-500 dark:text-slate-400 bg-white/50 dark:bg-slate-700/50 border border-slate-200 dark:border-slate-700 hover:bg-slate-200 dark:hover:bg-slate-700">
                           <i class="fas fa-search"></i><span class="hidden sm:inline text-sm">Buscar...</span><span class="hidden sm:inline text-xs text-slate-400 dark:text-slate-500">Ctrl+K</span>
                        </button>
                        <button id="theme-toggle" class="w-10 h-10 flex items-center justify-center rounded-full text-slate-500 dark:text-slate-400 bg-white/50 dark:bg-slate-700/50 border border-slate-200 dark:border-slate-700">
                            <i id="theme-toggle-dark-icon" class="fas fa-moon text-lg"></i>
                            <i id="theme-toggle-light-icon" class="fas fa-sun text-lg"></i>
                        </button>
                    </div>
                </div>
            </header>
            
            <main class="flex-1 overflow-y-auto p-6 animate-fadeIn space-y-6">
                <div class="bg-white/50 dark:bg-slate-800/50 backdrop-blur-lg p-6 rounded-2xl shadow-lg border border-slate-200/50 dark:border-slate-700/50 animate-fadeInUp">
                    <div class="flex flex-col sm:flex-row justify-between items-start mb-4">
                        <div id="chart-title-section">
                            <h3 class="text-lg font-bold text-slate-900 dark:text-white">Rendimiento de Ventas</h3>
                            <p class="text-sm text-slate-500 dark:text-slate-400">VisiÃ³n general de todas las ventas.</p>
                        </div>
                        <div class="flex flex-col sm:flex-row items-center space-y-2 sm:space-y-0 sm:space-x-4 mt-2 sm:mt-0">
                            <div id="chart-tabs" class="flex items-center space-x-2 bg-slate-100 dark:bg-slate-700 p-1 rounded-lg">
                                <button data-view="general" class="tab-btn px-3 py-1 text-sm font-semibold text-slate-500 dark:text-slate-400 rounded-md active">VisiÃ³n General</button>
                                <button data-view="product" class="tab-btn px-3 py-1 text-sm font-semibold text-slate-500 dark:text-slate-400 rounded-md">Por Producto</button>
                            </div>
                            <div id="time-filters" class="flex items-center space-x-2 bg-slate-100 dark:bg-slate-700 p-1 rounded-lg">
                                </div>
                        </div>
                    </div>
                    <div id="chart-controls" class="mb-4 relative">
                        <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 hidden" id="product-search-icon"></i>
                        <input id="product-search" type="text" class="hidden w-full sm:w-72 pl-9 pr-4 py-2 border border-slate-300 dark:border-slate-600 text-slate-900 dark:text-white bg-white dark:bg-slate-700 rounded-lg focus:ring-2 focus:ring-sky-500 focus:outline-none" placeholder="Buscar producto por SKU o nombre...">
                    </div>
                    <div id="main-chart" class="h-80"></div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-2 grid grid-cols-1 sm:grid-cols-2 gap-6 animate-fadeInUp" style="animation-delay: 200ms;">
                        <div class="bg-white/50 dark:bg-slate-800/50 backdrop-blur-lg p-5 rounded-2xl shadow-lg border border-slate-200/50 dark:border-slate-700/50"><p class="text-sm font-medium text-slate-500 dark:text-slate-400">Valor Inventario Total</p><p class="text-3xl font-bold text-slate-900 dark:text-white mt-1">$4.8M</p><span class="text-xs text-green-500 font-semibold">+5.2% vs Mes Anterior</span></div>
                        <div class="bg-white/50 dark:bg-slate-800/50 backdrop-blur-lg p-5 rounded-2xl shadow-lg border border-slate-200/50 dark:border-slate-700/50"><p class="text-sm font-medium text-slate-500 dark:text-slate-400">Unidades Disponibles</p><p class="text-3xl font-bold text-slate-900 dark:text-white mt-1">1,250</p><span class="text-xs text-red-500 font-semibold">-1.8% vs Mes Anterior</span></div>
                        
                        <div class="sm:col-span-2 bg-white/50 dark:bg-slate-800/50 backdrop-blur-lg p-6 rounded-2xl shadow-lg border border-slate-200/50 dark:border-slate-700/50">
                            <h3 class="text-lg font-bold text-slate-900 dark:text-white mb-4">Transacciones Recientes</h3>
                            <div class="overflow-x-auto">
                                <table class="w-full text-sm text-left"><thead class="bg-slate-50 dark:bg-slate-700/50 text-xs uppercase text-slate-500 dark:text-slate-400"><tr><th class="p-3">Producto</th><th class="p-3">Tipo</th><th class="p-3">Cantidad</th><th class="p-3">Fecha</th></tr></thead>
                                <tbody>
                                    <tr class="border-b dark:border-slate-700/50"><td class="p-3 font-medium text-slate-800 dark:text-white">Televisor OLED 55"</td><td class="p-3"><span class="px-2 py-1 text-xs font-semibold text-green-700 bg-green-100 rounded-full dark:text-green-200 dark:bg-green-700/20">Venta</span></td><td class="p-3 font-medium text-slate-800 dark:text-white">-5</td><td class="p-3 text-slate-500 dark:text-slate-400">Hoy, 07:15 a. m.</td></tr>
                                    <tr class="border-b dark:border-slate-700/50"><td class="p-3 font-medium text-slate-800 dark:text-white">AudÃ­fonos InalÃ¡mbricos</td><td class="p-3"><span class="px-2 py-1 text-xs font-semibold text-blue-700 bg-blue-100 rounded-full dark:text-blue-200 dark:bg-blue-700/20">Ingreso</span></td><td class="p-3 font-medium text-slate-800 dark:text-white">+50</td><td class="p-3 text-slate-500 dark:text-slate-400">Ayer, 04:30 p. m.</td></tr>
                                    <tr><td class="p-3 font-medium text-slate-800 dark:text-white">Cafetera Programable</td><td class="p-3"><span class="px-2 py-1 text-xs font-semibold text-green-700 bg-green-100 rounded-full dark:text-green-200 dark:bg-green-700/20">Venta</span></td><td class="p-3 font-medium text-slate-800 dark:text-white">-2</td><td class="p-3 text-slate-500 dark:text-slate-400">Hace 3 dÃ­as, 09:00 a. m.</td></tr>
                                </tbody></table>
                            </div>
                        </div>
                    </div>
                    
                    <div class="space-y-6 animate-fadeInUp" style="animation-delay: 300ms;">
                        <div class="bg-white/50 dark:bg-slate-800/50 backdrop-blur-lg p-6 rounded-2xl shadow-lg border border-slate-200/50 dark:border-slate-700/50">
                            <h3 class="text-lg font-bold text-slate-900 dark:text-white mb-4">Top 5 Productos Vendidos</h3>
                            <ul class="space-y-4 text-sm">
                                <li class="flex justify-between items-center text-slate-800 dark:text-white"><span>1. Televisor OLED 55"</span><span class="font-semibold text-sky-500">2,100 uds</span></li>
                                <li class="flex justify-between items-center text-slate-800 dark:text-white"><span>2. AudÃ­fonos InalÃ¡mbricos</span><span class="font-semibold text-sky-500">1,850 uds</span></li>
                                <li class="flex justify-between items-center text-slate-800 dark:text-white"><span>3. Smartphone Premium</span><span class="font-semibold text-sky-500">1,500 uds</span></li>
                                <li class="flex justify-between items-center text-slate-800 dark:text-white"><span>4. Cafetera Programable</span><span class="font-semibold text-sky-500">1,120 uds</span></li>
                                <li class="flex justify-between items-center text-slate-800 dark:text-white"><span>5. Laptop Ultradelgada</span><span class="font-semibold text-sky-500">980 uds</span></li>
                            </ul>
                        </div>
                        <div class="bg-white/50 dark:bg-slate-800/50 backdrop-blur-lg p-6 rounded-2xl shadow-lg border border-slate-200/50 dark:border-slate-700/50">
                             <h3 class="text-lg font-bold text-slate-900 dark:text-white mb-4">Alertas de Stock CrÃ­tico</h3>
                             <ul class="space-y-4 text-sm">
                                <li class="flex justify-between items-center text-red-600 dark:text-red-400"><i class="fas fa-exclamation-triangle mr-2"></i><span>Aceite Vegetal (10 Lts)</span><span class="font-semibold">20 uds</span></li>
                                <li class="flex justify-between items-center text-red-600 dark:text-red-400"><i class="fas fa-exclamation-triangle mr-2"></i><span>Leche Entera (Litro)</span><span class="font-semibold">50 uds</span></li>
                                <li class="flex justify-between items-center text-amber-600 dark:text-amber-400"><i class="fas fa-exclamation-circle mr-2"></i><span>AzÃºcar Refinada (Kg)</span><span class="font-semibold">35 uds</span></li>
                             </ul>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <div id="command-palette-modal" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex justify-center items-start pt-20 animate-fadeIn cursor-close">
        <div class="bg-white dark:bg-slate-800 w-full max-w-xl rounded-xl shadow-2xl border dark:border-slate-700 cursor-default">
            <input type="text" class="w-full p-4 bg-transparent text-lg focus:outline-none text-slate-900 dark:text-white border-b dark:border-slate-700" placeholder="Escribe un comando o busca...">
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- LÃ³gica del Reloj en Vivo para Colombia ---
            const clockElement = document.getElementById('live-clock');
            function updateClock() {
                const now = new Date();
                const timeString = now.toLocaleTimeString('es-CO', { timeZone: 'America/Bogota', hour: '2-digit', minute: '2-digit', hour12: true });
                const dateString = now.toLocaleDateString('es-CO', { weekday: 'long', month: 'long', day: 'numeric' });
                clockElement.textContent = `${dateString.charAt(0).toUpperCase() + dateString.slice(1)} | ${timeString}`;
            }
            setInterval(updateClock, 1000);
            updateClock();

            // --- LÃ³gica de la Paleta de Comandos ---
            const cmdButton = document.getElementById('command-palette-button');
            const cmdModal = document.getElementById('command-palette-modal');
            const toggleCommandPalette = () => cmdModal.classList.toggle('hidden');
            cmdButton.addEventListener('click', toggleCommandPalette);
            cmdModal.addEventListener('click', (e) => { if (e.target === cmdModal) toggleCommandPalette(); });
            window.addEventListener('keydown', (e) => {
                if (e.key === 'k' && (e.metaKey || e.ctrlKey)) { e.preventDefault(); toggleCommandPalette(); }
                if (e.key === 'Escape' && !cmdModal.classList.contains('hidden')) { toggleCommandPalette(); }
            });

            // --- LÃ³gica del Cambio de Tema ---
            const themeToggleBtn = document.getElementById('theme-toggle');
            const updateTheme = () => {
                const isDark = document.documentElement.classList.contains('dark');
                document.getElementById('theme-toggle-dark-icon').style.display = isDark ? 'none' : 'block';
                document.getElementById('theme-toggle-light-icon').style.display = isDark ? 'block' : 'none';
                if(window.mainChart) { 
                    mainChart.updateOptions({ 
                        tooltip: { theme: isDark ? 'dark' : 'light' }, 
                        xaxis: { labels: { style: { colors: isDark ? '#94a3b8' : '#64748b' } } }, 
                        yaxis: { labels: { style: { colors: isDark ? '#94a3b8' : '#64748b' } } } 
                    }); 
                }
            };
            themeToggleBtn.addEventListener('click', () => {
                document.documentElement.classList.toggle('dark');
                localStorage.setItem('theme', document.documentElement.classList.contains('dark') ? 'dark' : 'light');
                updateTheme();
            });
            
            // --- LÃ³gica de GrÃ¡ficos Unificados (CORREGIDA Y MEJORADA) ---
            const chartTitleSection = document.getElementById('chart-title-section');
            const productSearchInput = document.getElementById('product-search');
            const productSearchIcon = document.getElementById('product-search-icon');
            const chartTabs = document.querySelectorAll('#chart-tabs button');
            const timeFiltersContainer = document.getElementById('time-filters');
            
            const salesData = {
                monthly: { series: [{ name: 'Ventas', data: [450, 550, 620, 580, 700, 800, 750, 900, 850, 1100, 1050, 1200] }], categories: ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'] },
                annual: { series: [{ name: 'Ventas', data: [12000, 15000, 18000, 22000, 25000] }], categories: ['2020', '2021', '2022', '2023', '2024'] }
            };
            const productSalesData = {
                monthly: { series: [{ name: 'Ventas', data: [150, 200, 180, 220, 250, 300, 280, 320, 310, 350, 340, 400] }], categories: ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'] },
                annual: { series: [{ name: 'Ventas', data: [1500, 1800, 2200, 2500, 3000] }], categories: ['2020', '2021', '2022', '2023', '2024'] }
            };

            const getBaseChartOptions = () => ({
                chart: { type: 'area', height: '100%', toolbar: { show: false }, background: 'transparent' },
                dataLabels: { enabled: false }, stroke: { curve: 'smooth', width: 3 },
                fill: { type: 'gradient', gradient: { opacityFrom: 0.6, opacityTo: 0.1, stops: [0, 95, 100] } },
                grid: { borderColor: '#e2e8f030', strokeDashArray: 5, padding: { left: -10, right: 10 } },
                tooltip: { theme: localStorage.getItem('theme') || 'light' }, legend: { show: false },
                xaxis: { labels: { style: { colors: document.documentElement.classList.contains('dark') ? '#94a3b8' : '#64748b' } }, axisBorder: { show: false }, axisTicks: { show: false } },
                yaxis: { labels: { style: { colors: document.documentElement.classList.contains('dark') ? '#94a3b8' : '#64748b' } }, min: 0 }
            });

            // Se inicializa el grÃ¡fico con la configuraciÃ³n y datos por defecto (VisiÃ³n General, Mensual)
            const initialChartOptions = {
                ...getBaseChartOptions(),
                series: salesData.monthly.series,
                xaxis: { ...getBaseChartOptions().xaxis, categories: salesData.monthly.categories },
                colors: ['#0ea5e9']
            };
            window.mainChart = new ApexCharts(document.querySelector("#main-chart"), initialChartOptions);
            mainChart.render();

            let currentChartView = 'general';
            let currentChartTimeframe = 'monthly';

            const renderTimeFilters = (filters) => {
                timeFiltersContainer.innerHTML = '';
                filters.forEach(timeframe => {
                    const button = document.createElement('button');
                    button.dataset.timeframe = timeframe;
                    button.className = 'chart-filter-btn px-3 py-1 text-sm font-semibold text-slate-500 dark:text-slate-400 rounded-md transition-all-300';
                    button.textContent = timeframe.charAt(0).toUpperCase() + timeframe.slice(1);
                    if (timeframe === currentChartTimeframe) {
                        button.classList.add('active');
                    }
                    button.addEventListener('click', () => {
                        document.querySelectorAll('#time-filters .chart-filter-btn').forEach(btn => btn.classList.remove('active'));
                        button.classList.add('active');
                        currentChartTimeframe = timeframe;
                        updateChart();
                    });
                    timeFiltersContainer.appendChild(button);
                });
            };

            const updateChart = () => {
                let data = currentChartView === 'general' ? salesData[currentChartTimeframe] : productSalesData[currentChartTimeframe];
                let color = currentChartView === 'general' ? ['#0ea5e9'] : ['#22c55e'];
                mainChart.updateOptions({ series: data.series, xaxis: { categories: data.categories }, colors: color });
            };

            const updateChartViewUI = (view) => {
                currentChartView = view;
                if (view === 'general') {
                    productSearchInput.classList.add('hidden');
                    productSearchIcon.classList.add('hidden');
                    chartTitleSection.querySelector('h3').textContent = 'Rendimiento General de Ventas';
                    chartTitleSection.querySelector('p').textContent = 'VisiÃ³n general de todas las ventas.';
                    currentChartTimeframe = 'monthly'; // Reset
                    renderTimeFilters(['monthly', 'annual']);
                } else if (view === 'product') {
                    productSearchInput.classList.remove('hidden');
                    productSearchIcon.classList.remove('hidden');
                    chartTitleSection.querySelector('h3').innerHTML = 'AnÃ¡lisis de Producto: <span class="text-sky-500">Televisor OLED 55"</span>';
                    chartTitleSection.querySelector('p').textContent = 'Rendimiento de ventas del producto seleccionado.';
                    currentChartTimeframe = 'monthly'; // Reset
                    renderTimeFilters(['monthly', 'annual']);
                }
                updateChart();
            };

            chartTabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    chartTabs.forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    updateChartViewUI(tab.dataset.view);
                });
            });
            
            // Inicializar la vista y el tema
            updateChartViewUI('general');
            updateTheme();
        });
    </script>
</body>
</html>